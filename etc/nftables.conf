#!/usr/sbin/nft -f
# nftables firewall for Arch Linux laptop
# Policy: Default deny incoming, allow all outgoing

flush ruleset

table inet filter {
    chain input {
        type filter hook input priority filter; policy drop;

        # Accept loopback (required for local applications)
        iif lo accept comment "Accept loopback"

        # Drop invalid packets early
        ct state invalid drop comment "Drop invalid connections"

        # Accept established/related connections
        ct state { established, related } accept comment "Accept established"

        # ICMP - rate limited to prevent abuse
        meta l4proto icmp icmp type echo-request limit rate 10/second burst 4 packets accept comment "Accept IPv4 ping"

        # ICMPv6 - required for IPv6 operation
        meta l4proto ipv6-icmp icmpv6 type {
            echo-request,
            destination-unreachable,
            packet-too-big,
            time-exceeded,
            parameter-problem,
            nd-neighbor-solicit,
            nd-neighbor-advert,
            nd-router-solicit,
            nd-router-advert
        } accept comment "Accept ICMPv6"

        # IGMP for multicast group membership
        ip protocol igmp accept comment "Accept IGMP"

        # mDNS for local service discovery (printers, Avahi, etc.)
        udp dport mdns ip daddr 224.0.0.251 accept comment "Accept mDNS IPv4"
        udp dport mdns ip6 daddr ff02::fb accept comment "Accept mDNS IPv6"

        # LocalSend file sharing (TCP for transfers, UDP for discovery)
        tcp dport 53317 accept comment "Accept LocalSend TCP"
        udp dport 53317 accept comment "Accept LocalSend UDP"

        # Minecraft server
        tcp dport 1337 accept comment "Accept Minecraft server"

        # All other incoming traffic is dropped by policy
    }

    chain forward {
        type filter hook forward priority filter; policy drop;
        # Laptop doesn't route packets
    }

    chain output {
        type filter hook output priority filter; policy accept;
        # Allow all outbound connections
    }
}
