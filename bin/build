#!/usr/bin/env bash
# Build the dotfiles Docker image
#
# Usage:
#   build              # Build the image
#   build --push       # Build and push to registry
#   build --no-cache   # Build without cache

set -euo pipefail

IMAGE="cr.holdenitdown.net/rfhold/dot"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"

# Detect container engine - prefer podman, fall back to docker
if command -v podman &>/dev/null; then
    ENGINE=podman
elif command -v docker &>/dev/null; then
    ENGINE=docker
else
    echo "Error: No container engine found. Install podman or docker." >&2
    exit 1
fi

PUSH=false
BUILD_ARGS=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        --push)
            PUSH=true
            shift
            ;;
        --no-cache)
            BUILD_ARGS+=("--no-cache")
            shift
            ;;
        *)
            BUILD_ARGS+=("$1")
            shift
            ;;
    esac
done

echo "Building $IMAGE with $ENGINE..."
$ENGINE build "${BUILD_ARGS[@]+"${BUILD_ARGS[@]}"}" -t "$IMAGE" "$REPO_DIR"

if [[ "$PUSH" == true ]]; then
    echo "Pushing $IMAGE..."
    $ENGINE push "$IMAGE"
fi

echo "Done."
