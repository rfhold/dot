#!/usr/bin/env bash
# Detects if GPG signing key is available and configures git accordingly
# Creates ~/.gitconfig.local with appropriate includes
#
# Usage:
#   setup-git-signing          # Run setup
#   setup-git-signing --check  # Exit 0 if config is current, 1 if needs update

set -euo pipefail

SIGNING_KEY="A33869EE3103EC567EF5FC528D37CEAFACDCC958"
LOCAL_CONFIG="$HOME/.gitconfig.local"

# Check if the signing key exists in GPG keyring
has_gpg_key() {
    command -v gpg >/dev/null 2>&1 || return 1
    gpg --list-secret-keys "$SIGNING_KEY" >/dev/null 2>&1
}

# Check if current config matches expected state
config_is_current() {
    [[ -f "$LOCAL_CONFIG" ]] || return 1
    
    if has_gpg_key; then
        # GPG key exists - config should include gpg settings
        grep -q "path = ~/.gitconfig-gpg" "$LOCAL_CONFIG" 2>/dev/null
    else
        # No GPG key - config should NOT include gpg settings
        ! grep -q "path = ~/.gitconfig-gpg" "$LOCAL_CONFIG" 2>/dev/null
    fi
}

# Handle --check flag
if [[ "${1:-}" == "--check" ]]; then
    if config_is_current; then
        echo "current"
        exit 0
    else
        echo "needs_update"
        exit 1
    fi
fi

# Run setup
if has_gpg_key; then
    echo "GPG signing key found, enabling commit signing"
    cat > "$LOCAL_CONFIG" << 'EOF'
# Auto-generated by setup-git-signing
# GPG key detected - signing enabled
[include]
	path = ~/.gitconfig-gpg
EOF
else
    echo "GPG signing key not found, commit signing disabled"
    cat > "$LOCAL_CONFIG" << 'EOF'
# Auto-generated by setup-git-signing
# No GPG key detected - signing disabled
# Run 'setup-git-signing' after importing your GPG key to enable signing
EOF
fi

echo "Wrote $LOCAL_CONFIG"
