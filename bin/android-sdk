#!/usr/bin/env bash

# android-sdk - Android SDK management script
# Usage: android-sdk
#
# Features:
#   - Bootstrap Android SDK installation
#   - Install/remove SDK packages
#   - Manage Android Virtual Devices (AVDs)
#   - Launch emulators
#   - View SDK status

set -euo pipefail

# Global constants
ANDROID_SDK_ROOT="${HOME}/Android/Sdk"
CMDLINE_TOOLS_DIR="${ANDROID_SDK_ROOT}/cmdline-tools"
SDKMANAGER="${CMDLINE_TOOLS_DIR}/latest/bin/sdkmanager"
AVDMANAGER="${CMDLINE_TOOLS_DIR}/latest/bin/avdmanager"
EMULATOR="${ANDROID_SDK_ROOT}/emulator/emulator"
JDK_PATH="/usr/lib/jvm/java-17-openjdk"

# Detect AVD home directory
# avdmanager respects XDG_CONFIG_HOME and puts AVDs under $XDG_CONFIG_HOME/.android/avd/
# but the emulator only checks $HOME/.android/avd/ unless ANDROID_AVD_HOME is set
if [ -n "${XDG_CONFIG_HOME:-}" ] && [ -d "${XDG_CONFIG_HOME}/.android/avd" ]; then
    ANDROID_AVD_HOME="${XDG_CONFIG_HOME}/.android/avd"
elif [ -d "${HOME}/.android/avd" ]; then
    ANDROID_AVD_HOME="${HOME}/.android/avd"
else
    # Default - will be created by avdmanager on first AVD creation
    ANDROID_AVD_HOME="${XDG_CONFIG_HOME:+${XDG_CONFIG_HOME}/.android/avd}"
    ANDROID_AVD_HOME="${ANDROID_AVD_HOME:-${HOME}/.android/avd}"
fi
export ANDROID_AVD_HOME

# Colors for output (using gum style)
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to check for required dependencies
check_dependencies() {
    local missing_deps=()
    
    # Check for required commands
    for cmd in gum curl unzip; do
        if ! command -v "$cmd" &>/dev/null; then
            missing_deps+=("$cmd")
        fi
    done
    
    # If any dependencies are missing, print error and exit
    if [ ${#missing_deps[@]} -gt 0 ]; then
        echo -e "${RED}Error: Missing required dependencies:${NC}" >&2
        for dep in "${missing_deps[@]}"; do
            echo -e "${RED}  - $dep${NC}" >&2
        done
        echo -e "${YELLOW}Please install missing dependencies and try again.${NC}" >&2
        exit 1
    fi
    
    echo -e "${GREEN}✓ All required dependencies found${NC}"
}

# Function to check if Android SDK is installed
is_sdk_installed() {
    if [ -x "$SDKMANAGER" ]; then
        return 0
    else
        return 1
    fi
}

# Function to install JDK 17
install_jdk() {
    gum style --border normal --padding "1 2" --border-foreground 33 "Installing JDK 17"
    echo ""
    
    # Check if JDK is already installed
    if [ -d "$JDK_PATH" ]; then
        echo -e "${GREEN}✓ JDK 17 already installed at: ${NC}$JDK_PATH"
        return 0
    fi
    
    echo -e "${YELLOW}Installing JDK 17 via pacman...${NC}"
    if sudo pacman -S --needed --noconfirm jdk17-openjdk; then
        echo -e "${GREEN}✓ JDK 17 installed successfully${NC}"
        
        # Verify installation
        if [ -d "$JDK_PATH" ]; then
            echo -e "${GREEN}✓ JDK path verified: ${NC}$JDK_PATH"
        else
            echo -e "${RED}Error: JDK installation succeeded but path not found${NC}" >&2
            exit 1
        fi
    else
        echo -e "${RED}Error: Failed to install JDK 17${NC}" >&2
        exit 1
    fi
    echo ""
}

# Function to download and extract Android command-line tools
download_cmdline_tools() {
    gum style --border normal --padding "1 2" --border-foreground 33 "Downloading Android Command-line Tools"
    echo ""
    
    local cmdline_tools_url="https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip"
    local temp_zip="/tmp/cmdline-tools.zip"
    
    # Create Android SDK root directory
    echo -e "${YELLOW}Creating SDK directory: ${NC}$ANDROID_SDK_ROOT"
    mkdir -p "$ANDROID_SDK_ROOT"
    
    # Download command-line tools
    echo -e "${YELLOW}Downloading command-line tools...${NC}"
    if curl -L -o "$temp_zip" "$cmdline_tools_url"; then
        echo -e "${GREEN}✓ Download complete${NC}"
    else
        echo -e "${RED}Error: Failed to download command-line tools${NC}" >&2
        exit 1
    fi
    
    # Extract to temporary location
    echo -e "${YELLOW}Extracting command-line tools...${NC}"
    local temp_extract="${ANDROID_SDK_ROOT}/cmdline-tools"
    mkdir -p "$temp_extract"
    if unzip -q "$temp_zip" -d "$temp_extract"; then
        echo -e "${GREEN}✓ Extraction complete${NC}"
    else
        echo -e "${RED}Error: Failed to extract command-line tools${NC}" >&2
        rm -f "$temp_zip"
        exit 1
    fi
    
    # Rename cmdline-tools/cmdline-tools to cmdline-tools/latest
    # This is required by Android SDK structure
    echo -e "${YELLOW}Setting up directory structure...${NC}"
    if [ -d "${temp_extract}/cmdline-tools" ]; then
        mv "${temp_extract}/cmdline-tools" "${temp_extract}/latest"
        echo -e "${GREEN}✓ Directory structure configured${NC}"
    else
        echo -e "${RED}Error: Unexpected archive structure${NC}" >&2
        exit 1
    fi
    
    # Clean up
    echo -e "${YELLOW}Cleaning up temporary files...${NC}"
    rm -f "$temp_zip"
    echo -e "${GREEN}✓ Cleanup complete${NC}"
    
    # Verify sdkmanager exists and is executable
    if [ -x "$SDKMANAGER" ]; then
        echo -e "${GREEN}✓ SDK Manager verified: ${NC}$SDKMANAGER"
    else
        echo -e "${RED}Error: SDK Manager not found or not executable${NC}" >&2
        exit 1
    fi
    echo ""
}

# Function to install baseline SDK packages
install_baseline_packages() {
    gum style --border normal --padding "1 2" --border-foreground 33 "Installing Baseline SDK Packages"
    echo ""
    
    # Export JAVA_HOME for sdkmanager
    export JAVA_HOME="$JDK_PATH"
    
    # Define baseline packages
    local packages=(
        "platform-tools"
        "platforms;android-34"
        "build-tools;34.0.0"
        "emulator"
        "system-images;android-34;google_apis;x86_64"
    )
    
    echo -e "${YELLOW}Installing the following packages:${NC}"
    for pkg in "${packages[@]}"; do
        echo -e "${BLUE}  - $pkg${NC}"
    done
    echo ""
    
    echo -e "${YELLOW}Running sdkmanager (this may take several minutes)...${NC}"
    if yes | "$SDKMANAGER" "${packages[@]}" 2>&1; then
        echo ""
        echo -e "${GREEN}✓ Baseline packages installed successfully${NC}"
    else
        echo ""
        echo -e "${RED}Error: Failed to install baseline packages${NC}" >&2
        exit 1
    fi
    echo ""
}

# Function to accept Android SDK licenses
accept_licenses() {
    gum style --border normal --padding "1 2" --border-foreground 33 "Accepting Android SDK Licenses"
    echo ""
    
    # Export JAVA_HOME for sdkmanager
    export JAVA_HOME="$JDK_PATH"
    
    echo -e "${YELLOW}Accepting all SDK licenses...${NC}"
    if yes | "$SDKMANAGER" --licenses >/dev/null 2>&1; then
        echo -e "${GREEN}✓ All licenses accepted${NC}"
    else
        echo -e "${YELLOW}⚠ License acceptance may have failed, but continuing...${NC}"
    fi
    echo ""
}

# Function to setup KVM hardware acceleration
setup_kvm() {
    gum style --border normal --padding "1 2" --border-foreground 33 "Setting Up Hardware Acceleration (KVM)"
    echo ""
    
    # Check if /dev/kvm exists
    if [ ! -c /dev/kvm ]; then
        echo -e "${YELLOW}⚠ KVM device not found at /dev/kvm${NC}"
        echo -e "${YELLOW}Hardware acceleration may not be available${NC}"
        echo ""
        return 0
    fi
    
    # Check if user is in kvm group
    if groups | grep -q '\bkvm\b'; then
        echo -e "${GREEN}✓ User already in kvm group${NC}"
        echo -e "${GREEN}✓ Hardware acceleration is enabled${NC}"
    else
        echo -e "${YELLOW}User not in kvm group${NC}"
        echo -e "${YELLOW}Adding user to kvm group for hardware acceleration...${NC}"
        
        if sudo usermod -aG kvm "$USER"; then
            echo -e "${GREEN}✓ User added to kvm group${NC}"
            echo ""
            echo -e "${YELLOW}⚠ IMPORTANT: You must log out and back in for this to take effect${NC}"
            echo -e "${YELLOW}⚠ After re-logging, hardware acceleration will be enabled${NC}"
        else
            echo -e "${RED}Error: Failed to add user to kvm group${NC}" >&2
            echo -e "${YELLOW}You can manually add yourself with: sudo usermod -aG kvm \$USER${NC}"
        fi
    fi
    
    echo ""
    echo -e "${BLUE}ℹ KVM provides significant performance benefits for the Android Emulator${NC}"
    echo -e "${BLUE}ℹ Without it, emulator performance will be degraded${NC}"
    echo ""
}

# Function to bootstrap Android SDK installation
bootstrap_sdk() {
    gum style \
        --border double \
        --padding "1 2" \
        --border-foreground 212 \
        --bold \
        "Android SDK Bootstrap" \
        "This will install the Android SDK from scratch"
    echo ""
    
    echo -e "${BLUE}The following components will be installed:${NC}"
    echo -e "  ${YELLOW}•${NC} JDK 17 (Java Development Kit)"
    echo -e "  ${YELLOW}•${NC} Android Command-line Tools"
    echo -e "  ${YELLOW}•${NC} Platform Tools (adb, fastboot)"
    echo -e "  ${YELLOW}•${NC} Android API 34 Platform"
    echo -e "  ${YELLOW}•${NC} Build Tools 34.0.0"
    echo -e "  ${YELLOW}•${NC} Android Emulator"
    echo -e "  ${YELLOW}•${NC} System Image (Android 34, x86_64)"
    echo ""
    echo -e "${BLUE}Installation location:${NC} $ANDROID_SDK_ROOT"
    echo -e "${BLUE}Estimated download size:${NC} ~2.5 GB"
    echo -e "${BLUE}Estimated disk space:${NC} ~3-4 GB"
    echo ""
    
    # Run bootstrap steps in sequence
    install_jdk
    download_cmdline_tools
    accept_licenses
    install_baseline_packages
    setup_kvm
    
    # Success message
    gum style \
        --border double \
        --padding "1 2" \
        --border-foreground 82 \
        --bold \
        "✓ Android SDK Bootstrap Complete!" \
        "" \
        "The Android SDK has been successfully installed." \
        "You can now build Android apps and use the emulator."
    echo ""
}

# Function to show SDK status
show_status() {
    # Export JAVA_HOME for SDK tools
    export JAVA_HOME="$JDK_PATH"
    
    # Display header
    gum style \
        --border normal \
        --padding "1 2" \
        --border-foreground 33 \
        --bold \
        "Android SDK Status"
    echo ""
    
    # SDK and JDK locations
    echo -e "${BLUE}SDK Location:${NC} $ANDROID_SDK_ROOT"
    echo -e "${BLUE}JDK Location:${NC} $JDK_PATH"
    echo ""
    
    # Installed SDK packages
    echo -e "${BLUE}Installed SDK Packages:${NC}"
    if [ -x "$SDKMANAGER" ]; then
        # Run sdkmanager and capture output
        local packages_output
        if packages_output=$("$SDKMANAGER" --list_installed 2>/dev/null); then
            # Filter and format the output (skip header lines and empty lines)
            echo "$packages_output" | grep -v '^---' | grep -v '^Installed packages:' | grep -v '^$' | grep -v '^Path' | while IFS='|' read -r path version description rest; do
                # Trim whitespace and display if path is not empty
                path=$(echo "$path" | xargs)
                version=$(echo "$version" | xargs)
                if [ -n "$path" ] && [ "$path" != "Path" ]; then
                    echo -e "  ${GREEN}•${NC} $path ${YELLOW}($version)${NC}"
                fi
            done
        else
            echo -e "  ${RED}Error: Unable to list installed packages${NC}"
        fi
    else
        echo -e "  ${RED}SDK Manager not found${NC}"
    fi
    echo ""
    
    # Installed AVDs
    echo -e "${BLUE}Installed AVDs:${NC}"
    if [ -x "$AVDMANAGER" ]; then
        local avds_output
        if avds_output=$("$AVDMANAGER" list avd 2>/dev/null); then
            # Parse AVD names from the output
            local avd_count=0
            while IFS= read -r line; do
                if [[ "$line" =~ ^[[:space:]]*Name:[[:space:]](.+)$ ]]; then
                    local avd_name="${BASH_REMATCH[1]}"
                    echo -e "  ${GREEN}•${NC} $avd_name"
                    ((avd_count++))
                fi
            done <<< "$avds_output"
            
            if [ "$avd_count" -eq 0 ]; then
                echo -e "  ${YELLOW}No AVDs installed${NC}"
            fi
        else
            echo -e "  ${RED}Error: Unable to list AVDs${NC}"
        fi
    else
        echo -e "  ${RED}AVD Manager not found${NC}"
    fi
    echo ""
    
    # KVM status
    echo -e "${BLUE}Hardware Acceleration (KVM):${NC}"
    if [ -c /dev/kvm ]; then
        if groups | grep -q '\bkvm\b'; then
            echo -e "  ${GREEN}✓ KVM available and accessible${NC}"
            
            # Check emulator acceleration support if emulator is installed
            if [ -x "$EMULATOR" ]; then
                local accel_output
                if accel_output=$("$EMULATOR" -accel-check 2>&1); then
                    echo -e "  ${GREEN}✓ Emulator acceleration check passed${NC}"
                fi
            fi
        else
            echo -e "  ${YELLOW}⚠ KVM exists but user not in kvm group${NC}"
            echo -e "    ${YELLOW}Run: sudo usermod -aG kvm \$USER${NC}"
            echo -e "    ${YELLOW}Then log out and back in${NC}"
        fi
    else
        echo -e "  ${RED}✗ KVM device not found at /dev/kvm${NC}"
        echo -e "    ${YELLOW}Hardware acceleration unavailable${NC}"
    fi
    echo ""
    
    # Running emulators
    echo -e "${BLUE}Running Emulators:${NC}"
    if command -v adb &>/dev/null; then
        local devices_output
        if devices_output=$(adb devices 2>/dev/null | grep 'emulator-'); then
            echo "$devices_output" | while read -r device status; do
                echo -e "  ${GREEN}•${NC} $device ${YELLOW}($status)${NC}"
            done
        else
            echo -e "  ${YELLOW}No emulators running${NC}"
        fi
    else
        echo -e "  ${YELLOW}adb not found (install platform-tools)${NC}"
    fi
    echo ""
    
    # Disk usage
    echo -e "${BLUE}Disk Usage:${NC}"
    if [ -d "$ANDROID_SDK_ROOT" ]; then
        local sdk_size
        sdk_size=$(du -sh "$ANDROID_SDK_ROOT" 2>/dev/null | cut -f1)
        echo -e "  SDK: ${YELLOW}$sdk_size${NC}"
    fi
    
    if [ -d "$HOME/.android/avd" ]; then
        local avd_size
        avd_size=$(du -sh "$HOME/.android/avd" 2>/dev/null | cut -f1)
        echo -e "  AVD data: ${YELLOW}$avd_size${NC}"
    fi
    echo ""
    
    # Wait for user to acknowledge before returning to menu
    gum input --placeholder "Press Enter to continue..." > /dev/null
}

# Function to install a package
install_package() {
    # Export JAVA_HOME for sdkmanager
    export JAVA_HOME="$JDK_PATH"
    
    gum style \
        --border normal \
        --padding "1 2" \
        --border-foreground 33 \
        "Install SDK Package"
    echo ""
    
    # Check that sdkmanager exists
    if [ ! -x "$SDKMANAGER" ]; then
        echo -e "${RED}Error: SDK Manager not found${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    # Show package categories
    echo -e "${BLUE}Select package category:${NC}"
    echo ""
    
    local category
    category=$(gum choose \
        "Platform Tools" \
        "Platforms (API levels)" \
        "Build Tools" \
        "Emulator" \
        "System Images" \
        "Other (custom package path)" \
        "Cancel" \
        || echo "Cancel")
    
    if [ "$category" = "Cancel" ]; then
        return
    fi
    
    echo ""
    
    local package_path=""
    
    case "$category" in
        "Platform Tools")
            package_path="platform-tools"
            ;;
        
        "Platforms (API levels)")
            echo -e "${BLUE}Enter Android API level (e.g., 34, 35):${NC}"
            local api_level
            api_level=$(gum input --placeholder "34" || echo "")
            
            if [ -z "$api_level" ]; then
                echo -e "${YELLOW}Installation cancelled${NC}"
                echo ""
                gum input --placeholder "Press Enter to continue..." > /dev/null
                return
            fi
            
            # Validate that API level is numeric
            if ! [[ "$api_level" =~ ^[0-9]+$ ]]; then
                echo -e "${RED}Error: API level must be a number${NC}"
                echo ""
                gum input --placeholder "Press Enter to continue..." > /dev/null
                return
            fi
            
            package_path="platforms;android-${api_level}"
            ;;
        
        "Build Tools")
            echo -e "${BLUE}Enter Build Tools version (e.g., 34.0.0, 35.0.0):${NC}"
            local version
            version=$(gum input --placeholder "34.0.0" || echo "")
            
            if [ -z "$version" ]; then
                echo -e "${YELLOW}Installation cancelled${NC}"
                echo ""
                gum input --placeholder "Press Enter to continue..." > /dev/null
                return
            fi
            
            # Basic validation for version format (X.Y.Z)
            if ! [[ "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                echo -e "${RED}Error: Version must be in format X.Y.Z (e.g., 34.0.0)${NC}"
                echo ""
                gum input --placeholder "Press Enter to continue..." > /dev/null
                return
            fi
            
            package_path="build-tools;${version}"
            ;;
        
        "Emulator")
            package_path="emulator"
            ;;
        
        "System Images")
            echo -e "${BLUE}Select system image variant:${NC}"
            echo ""
            
            local variant_choice
            variant_choice=$(gum choose \
                "Google APIs (recommended)" \
                "Google Play Store" \
                "AOSP (vanilla Android)" \
                "Cancel" \
                || echo "Cancel")
            
            if [ "$variant_choice" = "Cancel" ]; then
                return
            fi
            
            echo ""
            
            local variant=""
            case "$variant_choice" in
                "Google APIs (recommended)")
                    variant="google_apis"
                    ;;
                "Google Play Store")
                    variant="google_apis_playstore"
                    ;;
                "AOSP (vanilla Android)")
                    variant="default"
                    ;;
            esac
            
            echo -e "${BLUE}Enter Android API level (e.g., 34, 35):${NC}"
            local api_level
            api_level=$(gum input --placeholder "34" || echo "")
            
            if [ -z "$api_level" ]; then
                echo -e "${YELLOW}Installation cancelled${NC}"
                echo ""
                gum input --placeholder "Press Enter to continue..." > /dev/null
                return
            fi
            
            # Validate that API level is numeric
            if ! [[ "$api_level" =~ ^[0-9]+$ ]]; then
                echo -e "${RED}Error: API level must be a number${NC}"
                echo ""
                gum input --placeholder "Press Enter to continue..." > /dev/null
                return
            fi
            
            echo ""
            echo -e "${BLUE}Select architecture:${NC}"
            echo ""
            
            local arch
            arch=$(gum choose \
                "x86_64 (recommended)" \
                "arm64-v8a" \
                "Cancel" \
                || echo "Cancel")
            
            if [ "$arch" = "Cancel" ]; then
                return
            fi
            
            # Extract architecture value
            arch="${arch%% *}"
            
            package_path="system-images;android-${api_level};${variant};${arch}"
            ;;
        
        "Other (custom package path)")
            echo -e "${BLUE}Enter full package path (e.g., cmake;3.22.1):${NC}"
            package_path=$(gum input --placeholder "package-path" || echo "")
            
            if [ -z "$package_path" ]; then
                echo -e "${YELLOW}Installation cancelled${NC}"
                echo ""
                gum input --placeholder "Press Enter to continue..." > /dev/null
                return
            fi
            ;;
    esac
    
    echo ""
    echo -e "${YELLOW}Installing package: ${NC}${BLUE}$package_path${NC}"
    echo ""
    
    # Run sdkmanager to install the package
    if yes | "$SDKMANAGER" "$package_path" 2>&1; then
        echo ""
        echo -e "${GREEN}✓ Package installed successfully: ${NC}$package_path"
    else
        echo ""
        echo -e "${RED}✗ Failed to install package: ${NC}$package_path"
        echo -e "${YELLOW}Note: The package may not exist or may already be installed${NC}"
    fi
    
    echo ""
    gum input --placeholder "Press Enter to continue..." > /dev/null
}

# Function to remove a package
remove_package() {
    # Export JAVA_HOME for sdkmanager
    export JAVA_HOME="$JDK_PATH"
    
    gum style \
        --border normal \
        --padding "1 2" \
        --border-foreground 33 \
        "Remove SDK Package"
    echo ""
    
    # Check that sdkmanager exists
    if [ ! -x "$SDKMANAGER" ]; then
        echo -e "${RED}Error: SDK Manager not found${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    echo -e "${YELLOW}Fetching installed packages...${NC}"
    echo ""
    
    # Get list of installed packages
    local packages_output
    if ! packages_output=$("$SDKMANAGER" --list_installed 2>/dev/null); then
        echo -e "${RED}Error: Unable to list installed packages${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    # Parse package names from output
    local -a package_list=()
    while IFS='|' read -r path version description rest; do
        path=$(echo "$path" | xargs)
        if [ -n "$path" ] && [ "$path" != "Path" ] && [[ ! "$path" =~ ^--- ]]; then
            package_list+=("$path")
        fi
    done <<< "$packages_output"
    
    # Check if any packages are installed
    if [ ${#package_list[@]} -eq 0 ]; then
        echo -e "${YELLOW}No packages installed${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    # Let user select package to remove
    echo -e "${BLUE}Select package to remove:${NC}"
    echo ""
    
    # Add "Cancel" option to the list
    local choice
    choice=$(gum choose "${package_list[@]}" "Cancel" || echo "Cancel")
    
    if [ "$choice" = "Cancel" ] || [ -z "$choice" ]; then
        echo -e "${YELLOW}Removal cancelled${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    echo ""
    
    # Confirm removal
    if ! gum confirm "Remove package '$choice'?"; then
        echo -e "${YELLOW}Removal cancelled${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    echo ""
    echo -e "${YELLOW}Removing package: ${NC}${BLUE}$choice${NC}"
    echo ""
    
    # Run sdkmanager to uninstall the package
    if "$SDKMANAGER" --uninstall "$choice" 2>&1; then
        echo ""
        echo -e "${GREEN}✓ Package removed successfully: ${NC}$choice"
    else
        echo ""
        echo -e "${RED}✗ Failed to remove package: ${NC}$choice"
    fi
    
    echo ""
    gum input --placeholder "Press Enter to continue..." > /dev/null
}

# Function to update all packages
update_packages() {
    # Export JAVA_HOME for sdkmanager
    export JAVA_HOME="$JDK_PATH"
    
    gum style \
        --border normal \
        --padding "1 2" \
        --border-foreground 33 \
        "Update All SDK Packages"
    echo ""
    
    # Check that sdkmanager exists
    if [ ! -x "$SDKMANAGER" ]; then
        echo -e "${RED}Error: SDK Manager not found${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    # Show warning
    gum style \
        --border normal \
        --padding "1 2" \
        --border-foreground 208 \
        --foreground 208 \
        "⚠ WARNING" \
        "" \
        "This will update ALL installed SDK packages to their latest versions." \
        "This operation may take several minutes and download large files."
    echo ""
    
    # Confirm update
    if ! gum confirm "Update all packages?"; then
        echo -e "${YELLOW}Update cancelled${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    echo ""
    echo -e "${YELLOW}Updating all packages (this may take several minutes)...${NC}"
    echo ""
    
    # Run sdkmanager update
    if yes | "$SDKMANAGER" --update 2>&1; then
        echo ""
        echo -e "${GREEN}✓ All packages updated successfully${NC}"
    else
        echo ""
        echo -e "${RED}✗ Update failed or was interrupted${NC}"
    fi
    
    echo ""
    gum input --placeholder "Press Enter to continue..." > /dev/null
}

# Function to show installed packages
show_installed_packages() {
    # Export JAVA_HOME for sdkmanager
    export JAVA_HOME="$JDK_PATH"
    
    gum style \
        --border normal \
        --padding "1 2" \
        --border-foreground 33 \
        "Installed SDK Packages"
    echo ""
    
    # Check that sdkmanager exists
    if [ ! -x "$SDKMANAGER" ]; then
        echo -e "${RED}Error: SDK Manager not found${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    echo -e "${YELLOW}Fetching installed packages...${NC}"
    echo ""
    
    # Get list of installed packages
    local packages_output
    if ! packages_output=$("$SDKMANAGER" --list_installed 2>/dev/null); then
        echo -e "${RED}Error: Unable to list installed packages${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    # Parse and display packages
    local package_count=0
    echo -e "${BLUE}Package Path${NC} | ${BLUE}Version${NC} | ${BLUE}Description${NC}"
    echo "$(printf '%.0s-' {1..80})"
    
    while IFS='|' read -r path version description rest; do
        path=$(echo "$path" | xargs)
        version=$(echo "$version" | xargs)
        description=$(echo "$description" | xargs)
        
        if [ -n "$path" ] && [ "$path" != "Path" ] && [[ ! "$path" =~ ^--- ]] && [ "$path" != "Installed packages:" ]; then
            echo -e "${GREEN}$path${NC} | ${YELLOW}$version${NC} | $description"
            ((package_count++))
        fi
    done <<< "$packages_output"
    
    echo ""
    echo -e "${BLUE}Total installed packages: ${NC}${GREEN}$package_count${NC}"
    echo ""
    
    gum input --placeholder "Press Enter to continue..." > /dev/null
}

# Function to manage packages (main package management menu)
manage_packages() {
    # Infinite loop for package management sub-menu
    while true; do
        echo ""
        gum style \
            --border normal \
            --padding "1 2" \
            --border-foreground 33 \
            --bold \
            "Package Management"
        echo ""
        
        # Present sub-menu options
        local choice
        choice=$(gum choose \
            "Install Package" \
            "Remove Package" \
            "Update All Packages" \
            "Show Installed Packages" \
            "Back to Main Menu" \
            || echo "Back to Main Menu")
        
        echo ""
        
        # Dispatch based on selection
        case "$choice" in
            "Install Package")
                install_package
                ;;
            "Remove Package")
                remove_package
                ;;
            "Update All Packages")
                update_packages
                ;;
            "Show Installed Packages")
                show_installed_packages
                ;;
            "Back to Main Menu")
                # Break the loop and return to main menu
                break
                ;;
            *)
                # Handle unexpected input (e.g., Ctrl+C on gum choose)
                break
                ;;
        esac
    done
}

# Stub: Manage AVDs (Phase 4)
# Function to list all AVDs
list_avds() {
    # Export JAVA_HOME for avdmanager
    export JAVA_HOME="$JDK_PATH"
    
    gum style \
        --border normal \
        --padding "1 2" \
        --border-foreground 33 \
        "List Android Virtual Devices"
    echo ""
    
    # Check that avdmanager exists
    if [ ! -x "$AVDMANAGER" ]; then
        echo -e "${RED}Error: AVD Manager not found${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    echo -e "${YELLOW}Fetching AVDs...${NC}"
    echo ""
    
    # Get list of AVDs
    local avd_output
    if ! avd_output=$("$AVDMANAGER" list avd 2>/dev/null); then
        echo -e "${RED}Error: Unable to list AVDs${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    # Check if any AVDs exist
    if ! echo "$avd_output" | grep -q "Name:"; then
        echo -e "${YELLOW}No AVDs found${NC}"
        echo -e "${BLUE}Create an AVD first to get started${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    # Parse and display AVDs nicely
    echo -e "${BLUE}Available AVDs:${NC}"
    echo ""
    
    local current_avd=""
    local current_target=""
    local current_device=""
    local current_path=""
    
    while IFS= read -r line; do
        if [[ "$line" =~ ^[[:space:]]*Name:[[:space:]]*(.*) ]]; then
            # If we have a previous AVD, display it
            if [ -n "$current_avd" ]; then
                echo -e "${GREEN}● $current_avd${NC}"
                [ -n "$current_target" ] && echo "  Target:  $current_target"
                [ -n "$current_device" ] && echo "  Device:  $current_device"
                [ -n "$current_path" ] && echo "  Path:    $current_path"
                echo ""
            fi
            
            # Start new AVD
            current_avd="${BASH_REMATCH[1]}"
            current_target=""
            current_device=""
            current_path=""
        elif [[ "$line" =~ ^[[:space:]]*Target:[[:space:]]*(.*) ]]; then
            current_target="${BASH_REMATCH[1]}"
        elif [[ "$line" =~ ^[[:space:]]*Device:[[:space:]]*(.*) ]]; then
            current_device="${BASH_REMATCH[1]}"
        elif [[ "$line" =~ ^[[:space:]]*Path:[[:space:]]*(.*) ]]; then
            current_path="${BASH_REMATCH[1]}"
        fi
    done <<< "$avd_output"
    
    # Display the last AVD
    if [ -n "$current_avd" ]; then
        echo -e "${GREEN}● $current_avd${NC}"
        [ -n "$current_target" ] && echo "  Target:  $current_target"
        [ -n "$current_device" ] && echo "  Device:  $current_device"
        [ -n "$current_path" ] && echo "  Path:    $current_path"
        echo ""
    fi
    
    gum input --placeholder "Press Enter to continue..." > /dev/null
}

# Function to create a new AVD
create_avd() {
    # Export JAVA_HOME for avdmanager
    export JAVA_HOME="$JDK_PATH"
    
    gum style \
        --border normal \
        --padding "1 2" \
        --border-foreground 33 \
        "Create Android Virtual Device"
    echo ""
    
    # Check that avdmanager exists
    if [ ! -x "$AVDMANAGER" ]; then
        echo -e "${RED}Error: AVD Manager not found${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    # Check for installed system images
    echo -e "${YELLOW}Checking for installed system images...${NC}"
    echo ""
    
    local system_images
    if ! system_images=$("$SDKMANAGER" --list_installed 2>/dev/null | grep "system-images;"); then
        echo -e "${RED}No system images installed${NC}"
        echo -e "${BLUE}Install a system image first (from Manage Packages menu)${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    # Parse system images into array
    local -a image_array
    while IFS= read -r line; do
        # Extract just the package path
        local pkg=$(echo "$line" | awk '{print $1}')
        if [ -n "$pkg" ]; then
            image_array+=("$pkg")
        fi
    done <<< "$system_images"
    
    if [ ${#image_array[@]} -eq 0 ]; then
        echo -e "${RED}No system images found${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    # Let user select system image
    echo -e "${BLUE}Select system image:${NC}"
    echo ""
    
    local selected_image
    selected_image=$(gum choose "${image_array[@]}" || echo "")
    
    if [ -z "$selected_image" ]; then
        echo -e "${YELLOW}AVD creation cancelled${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    echo ""
    
    # Get AVD name
    echo -e "${BLUE}Enter AVD name (alphanumeric, hyphens, underscores only):${NC}"
    echo ""
    
    local avd_name
    avd_name=$(gum input --placeholder "my-avd" || echo "")
    
    if [ -z "$avd_name" ]; then
        echo -e "${YELLOW}AVD creation cancelled${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    # Validate AVD name
    if ! [[ "$avd_name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        echo -e "${RED}Error: Invalid AVD name. Use only alphanumeric characters, hyphens, and underscores.${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    echo ""
    
    # Select device type
    echo -e "${BLUE}Select device type:${NC}"
    echo ""
    
    local device_choice
    device_choice=$(gum choose \
        "pixel_7 (recommended)" \
        "pixel_6" \
        "pixel_5" \
        "custom (enter device ID)" \
        || echo "")
    
    if [ -z "$device_choice" ]; then
        echo -e "${YELLOW}AVD creation cancelled${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    echo ""
    
    local device_id
    case "$device_choice" in
        "pixel_7 (recommended)")
            device_id="pixel_7"
            ;;
        "pixel_6")
            device_id="pixel_6"
            ;;
        "pixel_5")
            device_id="pixel_5"
            ;;
        "custom (enter device ID)")
            echo -e "${BLUE}Enter device ID (e.g., Nexus 5X):${NC}"
            echo ""
            device_id=$(gum input --placeholder "Nexus 5X" || echo "")
            
            if [ -z "$device_id" ]; then
                echo -e "${YELLOW}AVD creation cancelled${NC}"
                echo ""
                gum input --placeholder "Press Enter to continue..." > /dev/null
                return
            fi
            echo ""
            ;;
        *)
            echo -e "${RED}Invalid choice${NC}"
            echo ""
            gum input --placeholder "Press Enter to continue..." > /dev/null
            return
            ;;
    esac
    
    # Create AVD
    echo -e "${YELLOW}Creating AVD '$avd_name'...${NC}"
    echo ""
    
    if echo "no" | "$AVDMANAGER" create avd \
        -n "$avd_name" \
        -k "$selected_image" \
        -d "$device_id" 2>&1; then
        echo ""
        echo -e "${GREEN}✓ AVD created successfully${NC}"
        echo ""
        echo -e "${BLUE}AVD Details:${NC}"
        echo "  Name:         $avd_name"
        echo "  System Image: $selected_image"
        echo "  Device:       $device_id"
    else
        echo ""
        echo -e "${RED}✗ Failed to create AVD${NC}"
        echo -e "${YELLOW}This may be because an AVD with that name already exists${NC}"
    fi
    
    echo ""
    gum input --placeholder "Press Enter to continue..." > /dev/null
}

# Function to delete an AVD
delete_avd() {
    # Export JAVA_HOME for avdmanager
    export JAVA_HOME="$JDK_PATH"
    
    gum style \
        --border normal \
        --padding "1 2" \
        --border-foreground 33 \
        "Delete Android Virtual Device"
    echo ""
    
    # Check that avdmanager exists
    if [ ! -x "$AVDMANAGER" ]; then
        echo -e "${RED}Error: AVD Manager not found${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    # Get list of AVDs
    echo -e "${YELLOW}Fetching AVDs...${NC}"
    echo ""
    
    local avd_output
    if ! avd_output=$("$AVDMANAGER" list avd 2>/dev/null); then
        echo -e "${RED}Error: Unable to list AVDs${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    # Parse AVD names into array
    local -a avd_names
    while IFS= read -r line; do
        if [[ "$line" =~ ^[[:space:]]*Name:[[:space:]]*(.*) ]]; then
            avd_names+=("${BASH_REMATCH[1]}")
        fi
    done <<< "$avd_output"
    
    if [ ${#avd_names[@]} -eq 0 ]; then
        echo -e "${YELLOW}No AVDs found${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    # Let user select AVD to delete
    echo -e "${BLUE}Select AVD to delete:${NC}"
    echo ""
    
    local selected_avd
    selected_avd=$(gum choose "${avd_names[@]}" || echo "")
    
    if [ -z "$selected_avd" ]; then
        echo -e "${YELLOW}Deletion cancelled${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    echo ""
    
    # Confirm deletion
    if ! gum confirm "Delete AVD '$selected_avd'?"; then
        echo -e "${YELLOW}Deletion cancelled${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    echo ""
    echo -e "${YELLOW}Deleting AVD '$selected_avd'...${NC}"
    echo ""
    
    if "$AVDMANAGER" delete avd -n "$selected_avd" 2>&1; then
        echo ""
        echo -e "${GREEN}✓ AVD '$selected_avd' deleted successfully${NC}"
    else
        echo ""
        echo -e "${RED}✗ Failed to delete AVD${NC}"
    fi
    
    echo ""
    gum input --placeholder "Press Enter to continue..." > /dev/null
}

# Function to manage AVDs (submenu)
manage_avds() {
    while true; do
        echo ""
        gum style \
            --border normal \
            --padding "1 2" \
            --border-foreground 33 \
            "AVD Management"
        echo ""
        
        local action
        action=$(gum choose \
            "Create AVD" \
            "List AVDs" \
            "Delete AVD" \
            "Back to Main Menu" \
            || echo "Back to Main Menu")
        
        echo ""
        
        case "$action" in
            "Create AVD")
                create_avd
                ;;
            "List AVDs")
                list_avds
                ;;
            "Delete AVD")
                delete_avd
                ;;
            "Back to Main Menu")
                return
                ;;
        esac
    done
}

# Function to launch emulator
launch_emulator() {
    # Export JAVA_HOME for avdmanager
    export JAVA_HOME="$JDK_PATH"
    
    gum style \
        --border normal \
        --padding "1 2" \
        --border-foreground 33 \
        "Launch Android Emulator"
    echo ""
    
    # Check that emulator and avdmanager exist
    if [ ! -x "$EMULATOR" ]; then
        echo -e "${RED}Error: Emulator not found${NC}"
        echo -e "${BLUE}Install the emulator package first (from Manage Packages menu)${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    if [ ! -x "$AVDMANAGER" ]; then
        echo -e "${RED}Error: AVD Manager not found${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    # Get list of AVDs
    echo -e "${YELLOW}Fetching AVDs...${NC}"
    echo ""
    
    local avd_output
    if ! avd_output=$("$AVDMANAGER" list avd 2>/dev/null); then
        echo -e "${RED}Error: Unable to list AVDs${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    # Parse AVD names into array
    local -a avd_names
    while IFS= read -r line; do
        if [[ "$line" =~ ^[[:space:]]*Name:[[:space:]]*(.*) ]]; then
            avd_names+=("${BASH_REMATCH[1]}")
        fi
    done <<< "$avd_output"
    
    if [ ${#avd_names[@]} -eq 0 ]; then
        echo -e "${YELLOW}No AVDs found${NC}"
        echo -e "${BLUE}Create an AVD first (from Manage AVDs menu)${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    # Let user select AVD to launch
    echo -e "${BLUE}Select AVD to launch:${NC}"
    echo ""
    
    local selected_avd
    selected_avd=$(gum choose "${avd_names[@]}" || echo "")
    
    if [ -z "$selected_avd" ]; then
        echo -e "${YELLOW}Launch cancelled${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    echo ""
    
    # Select GPU mode
    echo -e "${BLUE}Select GPU mode:${NC}"
    echo ""
    
    local gpu_choice
    gpu_choice=$(gum choose \
        "auto (recommended - let emulator decide)" \
        "host (use host GPU, best performance)" \
        "swiftshader_indirect (software rendering, most compatible)" \
        "guest (guest GPU emulation)" \
        || echo "")
    
    if [ -z "$gpu_choice" ]; then
        echo -e "${YELLOW}Launch cancelled${NC}"
        echo ""
        gum input --placeholder "Press Enter to continue..." > /dev/null
        return
    fi
    
    # Extract GPU mode from choice
    local gpu_mode
    gpu_mode=$(echo "$gpu_choice" | awk '{print $1}')
    
    echo ""
    
    # Ask about headless mode
    local headless_flags=""
    if gum confirm "Launch in headless mode (no window)?"; then
        headless_flags="-no-window -no-audio -no-boot-anim"
    fi
    
    echo ""
    
    # Build emulator command
    local log_file="/tmp/emulator-${selected_avd}.log"
    
    echo -e "${YELLOW}Launching emulator in background...${NC}"
    echo ""
    
    # Launch emulator in background
    # Use nohup to prevent hangup and redirect all output to log file
    if nohup "$EMULATOR" -avd "$selected_avd" -gpu "$gpu_mode" $headless_flags > "$log_file" 2>&1 &
    then
        local emulator_pid=$!
        
        echo -e "${GREEN}✓ Emulator launched successfully${NC}"
        echo ""
        echo -e "${BLUE}Details:${NC}"
        echo "  AVD:      $selected_avd"
        echo "  GPU Mode: $gpu_mode"
        echo "  PID:      $emulator_pid"
        echo "  Log:      $log_file"
        echo ""
        echo -e "${YELLOW}Tips:${NC}"
        echo "  • Check status:    adb devices"
        echo "  • Kill emulator:   adb emu kill"
        echo "  • View logs:       tail -f $log_file"
    else
        echo -e "${RED}✗ Failed to launch emulator${NC}"
    fi
    
    echo ""
    gum input --placeholder "Press Enter to continue..." > /dev/null
}

# Function to show main menu
show_menu() {
    # Infinite loop for menu navigation
    while true; do
        # Clear screen and show header
        echo ""
        gum style \
            --border double \
            --padding "1 2" \
            --border-foreground 212 \
            --bold \
            "Android SDK Manager"
        echo ""
        
        # Present menu options with gum choose
        local choice
        choice=$(gum choose \
            "Show Status" \
            "Manage Packages" \
            "Manage AVDs" \
            "Launch Emulator" \
            "Exit" \
            || echo "Exit")
        
        echo ""
        
        # Dispatch based on selection
        case "$choice" in
            "Show Status")
                show_status
                ;;
            "Manage Packages")
                manage_packages
                ;;
            "Manage AVDs")
                manage_avds
                ;;
            "Launch Emulator")
                launch_emulator
                ;;
            "Exit")
                gum style \
                    --border normal \
                    --padding "1 2" \
                    --border-foreground 82 \
                    "Goodbye!" \
                    "" \
                    "Android SDK Manager closed."
                echo ""
                break
                ;;
            *)
                # Handle unexpected input (e.g., Ctrl+C on gum choose)
                echo -e "${YELLOW}Exiting...${NC}"
                echo ""
                break
                ;;
        esac
    done
}

# Main entry point
main() {
    echo -e "${GREEN}Android SDK Management Tool${NC}"
    echo "============================"
    echo ""
    
    # Check for dependencies
    check_dependencies
    echo ""
    
    # Check if SDK is installed
    if ! is_sdk_installed; then
        echo -e "${YELLOW}Android SDK not detected${NC}"
        echo ""
        echo -e "${BLUE}Location: ${NC}$ANDROID_SDK_ROOT"
        echo -e "${BLUE}SDK Manager: ${NC}$SDKMANAGER"
        echo ""
        
        # Ask user if they want to install
        if gum confirm "Would you like to install the Android SDK?"; then
            echo ""
            bootstrap_sdk
            
            # After successful bootstrap, offer to continue or exit
            echo ""
            if gum confirm "Bootstrap complete. Would you like to continue to the main menu?"; then
                echo ""
                show_menu
            else
                echo ""
                echo -e "${GREEN}Done! Run 'android-sdk' again to access the main menu.${NC}"
                exit 0
            fi
        else
            echo ""
            echo -e "${YELLOW}Installation cancelled. Run this script again when you're ready.${NC}"
            exit 0
        fi
    else
        # SDK is already installed, show main menu
        show_menu
    fi
}

# Run main function
main "$@"
