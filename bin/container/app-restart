#!/usr/bin/env bash
# Signal the entrypoint-supervised app to restart
#
# This sends SIGTERM to the app process after setting a restart flag.
# The entrypoint supervisor loop will detect the flag and restart the app.
#
# Usage:
#   app-restart

set -euo pipefail

PID_FILE="/tmp/app.pid"
RESTART_FLAG="/tmp/app-restart-requested"

if [[ ! -f "$PID_FILE" ]]; then
    echo "No app running (pid file not found at $PID_FILE)"
    exit 1
fi

APP_PID=$(cat "$PID_FILE")

if ! kill -0 "$APP_PID" 2>/dev/null; then
    echo "App process $APP_PID is not running"
    rm -f "$PID_FILE"
    exit 1
fi

# Signal restart intent, then terminate the app
touch "$RESTART_FLAG"
kill -TERM "$APP_PID"

echo "Restart signal sent to app (pid $APP_PID)"
echo "The app will restart shortly..."
