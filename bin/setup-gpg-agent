#!/usr/bin/env bash
# Generates ~/.gnupg/gpg-agent.conf with the pinentry-auto wrapper
#
# Usage:
#   setup-gpg-agent          # Run setup and restart agent
#   setup-gpg-agent --check  # Exit 0 if config is current, 1 if needs update

set -euo pipefail

CONFIG="$HOME/.gnupg/gpg-agent.conf"
LOG_FILE="$HOME/.gnupg/gpg-agent.log"

# Find pinentry-auto in the same directory as this script, or in PATH
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -x "$SCRIPT_DIR/pinentry-auto" ]]; then
    PINENTRY="$SCRIPT_DIR/pinentry-auto"
else
    PINENTRY="$(command -v pinentry-auto 2>/dev/null || echo "pinentry-auto")"
fi

# Generate the expected config content
generate_config() {
    cat << EOF
# Auto-generated by setup-gpg-agent
# Uses pinentry-auto wrapper for runtime environment detection
pinentry-program $PINENTRY
enable-ssh-support
ttyname \$GPG_TTY
default-cache-ttl 60
max-cache-ttl 120
use-standard-socket

# Logging
log-file $LOG_FILE
debug-level basic
EOF
}

# Check if current config matches expected state
config_is_current() {
    [[ -f "$CONFIG" ]] || return 1

    local expected
    expected=$(generate_config)
    local current
    current=$(cat "$CONFIG")

    [[ "$expected" == "$current" ]]
}

# Handle --check flag
if [[ "${1:-}" == "--check" ]]; then
    if config_is_current; then
        echo "current"
        exit 0
    else
        echo "needs_update"
        exit 1
    fi
fi

# Ensure .gnupg directory exists with correct permissions
mkdir -p "$HOME/.gnupg"
chmod 700 "$HOME/.gnupg"

# Generate config
generate_config > "$CONFIG"
chmod 600 "$CONFIG"

echo "Wrote $CONFIG with pinentry: $PINENTRY"

# Restart agent to pick up new config
gpgconf --kill gpg-agent 2>/dev/null || true
gpg-connect-agent /bye 2>/dev/null || true

echo "GPG agent restarted"
